using UnityEngine;
using System.Collections.Generic;
using UnityEditor;



/// <summary>
/// ステージ生成器
/// </summary>
public class StageGenerator : MonoBehaviour
{
   



    /// <summary>
    /// ギミック生成データ
    /// </summary>
    [System.Serializable]
    struct GenerationGimmickData
    {
        public GridPos gridPos;
        public GameObject prefab;
        public StageBlock.BlockType blockType; // ブロックの種類
    }




    /// <summary>
    /// 生成データ
    /// </summary>
    [System.Serializable]
    struct Generator
    {
        public GameObject generator;    // 生成機
        public float posY;              // 生成座標Y
    }


    [Header("==== 生成データ ==== ")]
    [Header("ギミック生成データ")]
    [SerializeField] private GenerationGimmickData[] m_gimmickData ;  // ギミックの生成機
    [Header("床生成データ")]
    [SerializeField] private GenerationGimmickData[] m_floorData ;  // ギミックの生成機
    [Header("終点生成データ")]
    [SerializeField] private GenerationGimmickData[] m_terminusData;  // 終点の生成機

    [Header("==== 生成機 ==== ")]
    
    [SerializeField] private Generator m_amidaTubeGenerator;  // あみだチューブの生成機

    [SerializeField] private Generator m_topFloorBlockGenerator;  // トップ層の床ブロックの生成機

    
   
    private void Awake()
    {
       
    }

    // Start is called once before the first execution of Update after the MonoBehaviour is created
    public void Start()
    {
      
    }

    public void Generate(AmidaManager amidaManager, Transform amidaParent, Transform floorParent, Transform gimmickParent, ClearConditionChecker clearConditionChecker)
    {
        // 床上部座標の設定
        float topFloorTopPartPosY = m_topFloorBlockGenerator.posY;
        float amidaPosY = m_amidaTubeGenerator.posY;

        var map = MapData.GetInstance;


        // トップ層の生成
        if (m_topFloorBlockGenerator.generator)
            m_topFloorBlockGenerator.generator.GetComponent<FloorBlockGenerator>().
            GenerateFloor(false, floorParent);

        // あみだチューブの生成
        if (m_amidaTubeGenerator.generator)

            m_amidaTubeGenerator.generator.GetComponent<AmidaTubeGenerator>().GenerateAmida(amidaParent);




        // ギミックの生成
        foreach (var generation in m_gimmickData)
        {
            GridPos fixedGridPos = new GridPos(generation.gridPos.x - 1, generation.gridPos.y - 1);

            GameObject instanceObj = Instantiate(generation.prefab, gimmickParent);
            map.GetStageGridData().TryPlaceTileObject(fixedGridPos, instanceObj);

            StageBlock stageBlock = instanceObj.GetComponent<StageBlock>();
            stageBlock.SetBlockType(generation.blockType);


            stageBlock.Initialize(fixedGridPos);
        }

        // 床の生成　通常床は自動で生成されている
        foreach (var generation in m_floorData)
        {

            GridPos fixedGridPos = new GridPos(generation.gridPos.x - 1, generation.gridPos.y - 1);


            // 床の生成
            GameObject instanceObj = Instantiate(generation.prefab, gimmickParent);

            //Vector3 pos = map.ConvertGridToWorldPos(fixedGridPos.x, fixedGridPos.y);
            //instanceObj.transform.position = new Vector3(pos.x, instanceObj.transform.position.y, pos.z);

            // 元々の床オブジェクトを無効化
            map.GetStageGridData().GetTileData[fixedGridPos.y, fixedGridPos.x].floor.SetActive(false);

            // 新しい床オブジェクトを設定
            map.GetStageGridData().TryPlaceTileObject(fixedGridPos, instanceObj);
            map.GetStageGridData().GetTileData[fixedGridPos.y, fixedGridPos.x].tileObject.gameObject = instanceObj;

            StageBlock stageBlock = instanceObj.GetComponent<StageBlock>();
            stageBlock.SetBlockType(StageBlock.BlockType.FEELING_SLOT);
            stageBlock.Initialize(fixedGridPos);


            if (instanceObj.GetComponent<FeelingSlot>() != null)
            {
                // FeelingSlotの初期化
                FeelingSlot feelingSlot = instanceObj.GetComponent<FeelingSlot>();
                amidaManager.AddFeelingSlot(feelingSlot);
            }


        }

        // 終点の生成
        foreach (var generation in m_terminusData)
        {
            GridPos fixedGridPos = new GridPos(generation.gridPos.x - 1, generation.gridPos.y - 1);
            GameObject instanceObj = Instantiate(generation.prefab, gimmickParent);

            // 新しい床オブジェクトを設定
            map.GetStageGridData().GetTileData[fixedGridPos.y, fixedGridPos.x].floor = instanceObj;

            // 新しい床オブジェクトを設定
            map.GetStageGridData().TryPlaceTileObject(fixedGridPos, instanceObj);
            map.GetStageGridData().GetTileData[fixedGridPos.y, fixedGridPos.x].tileObject.gameObject = instanceObj;

            StageBlock stageBlock = instanceObj.GetComponent<StageBlock>();
            stageBlock.SetBlockType(StageBlock.BlockType.FEELING_SLOT);
            stageBlock.Initialize(fixedGridPos);
            TerminusFeelingSlot terminusFeelingSlot = instanceObj.GetComponent<TerminusFeelingSlot>();
            if (terminusFeelingSlot != null)
            {
                clearConditionChecker.AddTerminusFeelingSlot(terminusFeelingSlot);
            }
        }





    }

  

}
